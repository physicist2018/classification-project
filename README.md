# classification-project

Программа для расчета коэффициентов пересчета обратного рассеяния в обьемную концентрацию


## Использование

```bash
$ ./algorithm -h
Usage of ./algorithm:
  -debug
        Флаг отладки
  -lambda float
        Параметр регуляризации (default 0.01)
  -navg int
        Количество решений для усреднения (default 10)
  -niters int
        Число повторений Монте-Карло (default 400)
  -npoints int
        Число точек для матрицы (default 4)
```


## необходимые файлы
В папке с файлом algorithm.exe должны находиться файлы:

- beta.txt
- Vol.txt
- s.txt
- d.txt
- u.txt

каждый из которых содержит данные в формате:

## Формат файлов
```
    "A"	"B"	"C"	"D"	"E"	"F"	"G"	"H"	"I"	"J"
"1005"	0.08903	0.09471	0.08728	0.13306	0.13794	0.10492	0.11279	0.11583	0.11914	0.11658
"1012.5"	0.1175	0.12467	0.08931	0.11801	0.14391	0.14325	0.11568	0.11526	0.11693	0.16151
"1020"	0.11164	0.13452	0.12107	0.09367	0.12245	0.13193	0.11741	0.13829	0.09794	0.09835
"1027.5"	0.08446	0.07747	0.10756	0.10923	0.10892	0.14364	0.0803	0.12376	0.13506	0.11463
"1035"	0.09937	0.10013	0.09604	0.12665	0.10589	0.14221	0.14208	0.09384	0.11883	0.12916
"1042.5"	0.12579	0.09853	0.06616	0.11877	0.10315	0.10577	0.08331	0.12387	0.10034	0.14899
"1050"	0.13626	0.06904	0.09389	0.09362	0.07601	0.09008	0.10836	0.08647	0.10994	0.12162
"1057.5"	0.07737	0.10531	0.09472	0.08341	0.10476	0.08812	0.07894	0.13195	0.11583	0.1088
"1065"	0.07418	0.07884	0.10247	0.1212	0.12062	0.07498	0.10812	0.11027	0.10811	0.0905
"1072.5"	0.11381	0.08851	0.09934	0.13403	0.08468	0.06079	0.08875	0.11171	0.09587	0.08703
"1080"	0.08032	0.08175	0.10597	0.07306	0.09188	0.07341	0.08821	0.1013	0.12674	0.08797
```

Названия столбцов и строк должны быть в двойных кавычках (надо поправить)


## Формат вывода в консоль

Результаты выводятся в консоль
```
Num Valid Solutions: 1000
Cv: [3.905e+06 1.627e+07 5.334e+06]
Discrepancy: 7.00e-01
Relative Discrepancy Matrix:
-3.17e-01  -4.33e-01  -3.12e-01  -6.27e-01  -6.91e-01  -4.84e-01  -5.93e-01  -4.83e-01  -5.91e-01  -5.77e-01
-3.49e-01  -3.94e-01  -2.69e-01  -5.62e-01  -6.58e-01  -4.73e-01  -5.34e-01  -4.29e-01  -5.60e-01  -5.36e-01
-3.42e-01  -3.41e-01  -2.00e-01  -4.74e-01  -6.08e-01  -4.33e-01  -4.85e-01  -4.33e-01  -5.02e-01  -4.49e-01
-2.08e-01  -3.19e-01  -1.49e-01  -3.99e-01  -4.96e-01  -3.65e-01  -4.56e-01  -3.59e-01  -4.71e-01  -4.56e-01
-2.71e-01  -3.54e-01  -1.63e-01  -3.52e-01  -4.28e-01  -3.48e-01  -4.46e-01  -4.01e-01  -4.59e-01  -3.85e-01
-2.61e-01  -2.81e-01  -1.13e-01  -3.39e-01  -4.28e-01  -3.69e-01  -4.02e-01  -3.86e-01  -4.22e-01  -3.83e-01
-2.02e-01  -2.01e-01  -1.17e-01  -2.93e-01  -3.95e-01  -2.68e-01  -3.78e-01  -3.33e-01  -4.14e-01  -3.78e-01
-1.94e-01  -3.35e-01  -1.03e-01  -2.04e-01  -3.55e-01  -2.85e-01  -3.54e-01  -3.72e-01  -4.04e-01  -3.38e-01
-2.02e-01  -2.40e-01  -3.39e-02  -2.29e-01  -3.32e-01  -2.73e-01  -3.65e-01  -2.90e-01  -3.71e-01  -3.32e-01
-3.29e-01  -2.26e-01  -8.35e-02  -2.62e-01  -3.06e-01  -2.47e-01  -2.85e-01  -2.51e-01  -2.89e-01  -3.70e-01
-2.38e-01  -2.16e-01  -1.35e-01  -1.36e-01  -3.10e-01  -2.70e-01  -2.91e-01  -2.82e-01  -3.53e-01  -2.53e-01
```

Чтобы перенаправить их в файл, надо выполнить команду:
```bash
./algorithm [необходимые аргументы] > output.txt
```


## Описание алгоритма

$$
n_u C_v^u LR^u+n_s C_v^s LR^s+n_d C_v^d LR^d= V/\beta_{532}
$$

$$
n_i=\frac{\beta_{532}^{i}}{\beta_{532}}, i \in [d,u,s] 
$$

$$
S_i = C_v^i LR^i, i \in [d,u,s]
$$

$$
n_u S_u+n_s S_s+n_d S_d= V/\beta_{532}
$$

Да, действительно, если мы знаем $V$ и $\beta_{532}$ из эксперимента, $n_i$ - из решения задачи о классификации, то можно таким образом найти коэффициенты перехода $S_i$. 

### Как составлять матрицы:

Из уравнения следует, что матрицы будут вырождены, если для трех коэффициентов, мы возьмем 3 уравнения, однако, для большего числа уравнений система будет иметь единственное решение в терминах наименьших квадратов.

Случайным образом из исходных данных выбирается $NPoints$ элементов, расположенных по одним и тем же координатам. Каждый элемент определяет одно уравнение в системе:

$$
n_u S_u+n_s S_s+n_d S_d= V/\beta_{532}
$$

Полученная таким образом матричное уравнение можно записать в виде:

$$
A x = b
$$

Решаем его методом наименьших квадратов с регуляризацией:

$$
x = (A^T A + \lambda I)^{-1} A^T b
$$

По полученному решению вычислеяем невязку в виде L2 нормы относительного отклонения 

$$
\|\frac{Ax - b}{b}\|_2^2
$$

Это все повторяем $Niters$ раз, полученные $NIters$ решений сортируем по невязке по возрастанию и усредняем $PointsToAvg$ лучших решений.

$$
\hat{x} = \frac{1}{PointsToAvg} \sum_{i=1}^{PointsToAvg} x_i
$$


Найденные $\hat{x}$ коэффициенты и есть искомые коэффициенты перехода


Далее, мы оцениваем корректность $\hat{x}$ нычислив для исходных матриц $N$ 

$$
b_i=V/\beta_{532}
$$
$$
n_u C_v^u LR^u+n_s C_v^s LR^s+n_d C_v^d LR^d - b_i = d_i
$$

$$
Err = \frac{d_i}{b_i}
$$

Матрица $Err$ пкажет,насколько корректно были найдены $\hat{x}$
